"""
Education-specific models for {{ app_name }} app.

Generated by CoreX - Django Scaffolding Framework
"""

from django.db import models
from django.contrib.auth.models import User
from django.urls import reverse
from django.utils import timezone
from django.utils.text import slugify


class Student(models.Model):
    """Student model for education platform."""
    user = models.OneToOneField(User, on_delete=models.CASCADE, related_name='{{ app_name }}_student_profile')
    student_id = models.CharField(max_length=20, unique=True)
    first_name = models.CharField(max_length=50)
    last_name = models.CharField(max_length=50)
    date_of_birth = models.DateField()
    email = models.EmailField()
    phone = models.CharField(max_length=15, blank=True)
    address = models.TextField(blank=True)
    enrollment_date = models.DateField(default=timezone.now)
    is_active = models.BooleanField(default=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        verbose_name = 'Student'
        verbose_name_plural = 'Students'
        ordering = ['last_name', 'first_name']
    
    def __str__(self):
        return f"{self.first_name} {self.last_name} ({self.student_id})"
    
    def get_absolute_url(self):
        return reverse('{{ app_name }}:student_detail', kwargs={'pk': self.pk})
    
    @property
    def full_name(self):
        return f"{self.first_name} {self.last_name}"


class Instructor(models.Model):
    """Instructor model for education platform."""
    user = models.OneToOneField(User, on_delete=models.CASCADE, related_name='{{ app_name }}_instructor_profile')
    employee_id = models.CharField(max_length=20, unique=True)
    first_name = models.CharField(max_length=50)
    last_name = models.CharField(max_length=50)
    email = models.EmailField()
    phone = models.CharField(max_length=15, blank=True)
    department = models.CharField(max_length=100)
    bio = models.TextField(blank=True)
    hire_date = models.DateField(default=timezone.now)
    is_active = models.BooleanField(default=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        verbose_name = 'Instructor'
        verbose_name_plural = 'Instructors'
        ordering = ['last_name', 'first_name']
    
    def __str__(self):
        return f"Prof. {self.first_name} {self.last_name}"
    
    def get_absolute_url(self):
        return reverse('{{ app_name }}:instructor_detail', kwargs={'pk': self.pk})
    
    @property
    def full_name(self):
        return f"{self.first_name} {self.last_name}"


class Department(models.Model):
    """Academic department model."""
    name = models.CharField(max_length=100, unique=True)
    code = models.CharField(max_length=10, unique=True)
    description = models.TextField(blank=True)
    head = models.ForeignKey(Instructor, on_delete=models.SET_NULL, null=True, blank=True, related_name='headed_departments')
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        verbose_name = 'Department'
        verbose_name_plural = 'Departments'
        ordering = ['name']
    
    def __str__(self):
        return f"{self.name} ({self.code})"


class Course(models.Model):
    """Course model for education platform."""
    code = models.CharField(max_length=20, unique=True)
    name = models.CharField(max_length=200)
    slug = models.SlugField(max_length=200, unique=True)
    description = models.TextField()
    department = models.ForeignKey(Department, on_delete=models.CASCADE, related_name='courses')
    credits = models.PositiveIntegerField(default=3)
    is_active = models.BooleanField(default=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        verbose_name = 'Course'
        verbose_name_plural = 'Courses'
        ordering = ['code']
    
    def __str__(self):
        return f"{self.code}: {self.name}"
    
    def save(self, *args, **kwargs):
        if not self.slug:
            self.slug = slugify(f"{self.code}-{self.name}")
        super().save(*args, **kwargs)
    
    def get_absolute_url(self):
        return reverse('{{ app_name }}:course_detail', kwargs={'slug': self.slug})


class Semester(models.Model):
    """Academic semester model."""
    TERM_CHOICES = [
        ('spring', 'Spring'),
        ('summer', 'Summer'),
        ('fall', 'Fall'),
        ('winter', 'Winter'),
    ]
    
    name = models.CharField(max_length=50)
    term = models.CharField(max_length=10, choices=TERM_CHOICES)
    year = models.PositiveIntegerField()
    start_date = models.DateField()
    end_date = models.DateField()
    is_active = models.BooleanField(default=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        verbose_name = 'Semester'
        verbose_name_plural = 'Semesters'
        ordering = ['-year', '-start_date']
        unique_together = ['term', 'year']
    
    def __str__(self):
        return f"{self.name} {self.year} ({self.term.title()})"


class CourseSection(models.Model):
    """Course section model for specific semester."""
    course = models.ForeignKey(Course, on_delete=models.CASCADE, related_name='sections')
    semester = models.ForeignKey(Semester, on_delete=models.CASCADE, related_name='course_sections')
    section_number = models.CharField(max_length=5)
    instructor = models.ForeignKey(Instructor, on_delete=models.CASCADE, related_name='teaching_sections')
    schedule_days = models.CharField(max_length=10)  # MTWRFSU (M,T,W,Th,F,S,Su)
    start_time = models.TimeField()
    end_time = models.TimeField()
    location = models.CharField(max_length=100)
    max_capacity = models.PositiveIntegerField(default=30)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        verbose_name = 'Course Section'
        verbose_name_plural = 'Course Sections'
        ordering = ['course__code', 'section_number']
        unique_together = ['course', 'semester', 'section_number']
    
    def __str__(self):
        return f"{self.course.code}-{self.section_number} ({self.semester})"


class Enrollment(models.Model):
    """Student enrollment in course sections."""
    student = models.ForeignKey(Student, on_delete=models.CASCADE, related_name='enrollments')
    course_section = models.ForeignKey(CourseSection, on_delete=models.CASCADE, related_name='enrollments')
    enrollment_date = models.DateTimeField(default=timezone.now)
    grade = models.CharField(max_length=2, blank=True)
    is_active = models.BooleanField(default=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        verbose_name = 'Enrollment'
        verbose_name_plural = 'Enrollments'
        unique_together = ['student', 'course_section']
        ordering = ['-enrollment_date']
    
    def __str__(self):
        return f"{self.student} enrolled in {self.course_section}"
    
    def get_absolute_url(self):
        return reverse('{{ app_name }}:enrollment_detail', kwargs={'pk': self.pk})


class Assignment(models.Model):
    """Course assignment model."""
    ASSIGNMENT_TYPES = [
        ('homework', 'Homework'),
        ('quiz', 'Quiz'),
        ('exam', 'Exam'),
        ('project', 'Project'),
        ('presentation', 'Presentation'),
    ]
    
    course_section = models.ForeignKey(CourseSection, on_delete=models.CASCADE, related_name='assignments')
    title = models.CharField(max_length=200)
    description = models.TextField()
    assignment_type = models.CharField(max_length=20, choices=ASSIGNMENT_TYPES, default='homework')
    due_date = models.DateTimeField()
    max_points = models.DecimalField(max_digits=5, decimal_places=2, default=100)
    is_active = models.BooleanField(default=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        verbose_name = 'Assignment'
        verbose_name_plural = 'Assignments'
        ordering = ['due_date']
    
    def __str__(self):
        return f"{self.title} ({self.course_section})"


class Submission(models.Model):
    """Student assignment submission."""
    student = models.ForeignKey(Student, on_delete=models.CASCADE, related_name='submissions')
    assignment = models.ForeignKey(Assignment, on_delete=models.CASCADE, related_name='submissions')
    submitted_at = models.DateTimeField(default=timezone.now)
    file = models.FileField(upload_to='education/submissions/', blank=True, null=True)
    content = models.TextField(blank=True)
    points_earned = models.DecimalField(max_digits=5, decimal_places=2, null=True, blank=True)
    feedback = models.TextField(blank=True)
    is_graded = models.BooleanField(default=False)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        verbose_name = 'Submission'
        verbose_name_plural = 'Submissions'
        unique_together = ['student', 'assignment']
        ordering = ['-submitted_at']
    
    def __str__(self):
        return f"{self.student} submission for {self.assignment}"


class Announcement(models.Model):
    """Course announcement model."""
    course_section = models.ForeignKey(CourseSection, on_delete=models.CASCADE, related_name='announcements')
    author = models.ForeignKey(Instructor, on_delete=models.CASCADE, related_name='announcements')
    title = models.CharField(max_length=200)
    content = models.TextField()
    is_published = models.BooleanField(default=True)
    published_at = models.DateTimeField(null=True, blank=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        verbose_name = 'Announcement'
        verbose_name_plural = 'Announcements'
        ordering = ['-published_at', '-created_at']
    
    def __str__(self):
        return f"{self.title} ({self.course_section})"
    
    def save(self, *args, **kwargs):
        if self.is_published and not self.published_at:
            self.published_at = timezone.now()
        super().save(*args, **kwargs)


class Grade(models.Model):
    """Student grade model."""
    enrollment = models.ForeignKey(Enrollment, on_delete=models.CASCADE, related_name='grades')
    assignment = models.ForeignKey(Assignment, on_delete=models.CASCADE, related_name='grades')
    points_earned = models.DecimalField(max_digits=5, decimal_places=2)
    points_possible = models.DecimalField(max_digits=5, decimal_places=2)
    letter_grade = models.CharField(max_length=2, blank=True)
    graded_by = models.ForeignKey(Instructor, on_delete=models.SET_NULL, null=True, blank=True)
    graded_at = models.DateTimeField(null=True, blank=True)
    feedback = models.TextField(blank=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        verbose_name = 'Grade'
        verbose_name_plural = 'Grades'
        unique_together = ['enrollment', 'assignment']
        ordering = ['-created_at']
    
    def __str__(self):
        return f"{self.enrollment.student} - {self.assignment.title}: {self.letter_grade}"
    
    @property
    def percentage(self):
        """Calculate grade percentage."""
        if self.points_possible > 0:
            return (float(self.points_earned) / float(self.points_possible)) * 100
        return 0
    
    def save(self, *args, **kwargs):
        # Auto-calculate letter grade based on percentage
        if self.points_possible > 0:
            percentage = self.percentage
            if percentage >= 90:
                self.letter_grade = 'A'
            elif percentage >= 80:
                self.letter_grade = 'B'
            elif percentage >= 70:
                self.letter_grade = 'C'
            elif percentage >= 60:
                self.letter_grade = 'D'
            else:
                self.letter_grade = 'F'
            
            # Set graded timestamp if not already set
            if not self.graded_at:
                self.graded_at = timezone.now()
        
        super().save(*args, **kwargs)


class Attendance(models.Model):
    """Student attendance model."""
    student = models.ForeignKey(Student, on_delete=models.CASCADE, related_name='attendance_records')
    course_section = models.ForeignKey(CourseSection, on_delete=models.CASCADE, related_name='attendance_records')
    date = models.DateField()
    status = models.CharField(max_length=20, choices=[
        ('present', 'Present'),
        ('absent', 'Absent'),
        ('late', 'Late'),
        ('excused', 'Excused Absence'),
    ])
    notes = models.TextField(blank=True)
    recorded_by = models.ForeignKey(Instructor, on_delete=models.SET_NULL, null=True, blank=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        verbose_name = 'Attendance'
        verbose_name_plural = 'Attendance Records'
        unique_together = ['student', 'course_section', 'date']
        ordering = ['-date']
    
    def __str__(self):
        return f"{self.student} - {self.course_section} - {self.date}: {self.status}"


class Guardian(models.Model):
    """Student guardian model for parent/guardian information."""
    student = models.ForeignKey(Student, on_delete=models.CASCADE, related_name='guardians')
    first_name = models.CharField(max_length=50)
    last_name = models.CharField(max_length=50)
    relationship = models.CharField(max_length=50)  # Parent, Guardian, etc.
    email = models.EmailField()
    phone = models.CharField(max_length=15)
    address = models.TextField()
    is_primary = models.BooleanField(default=False)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        verbose_name = 'Guardian'
        verbose_name_plural = 'Guardians'
        ordering = ['student', '-is_primary']
    
    def __str__(self):
        return f"{self.first_name} {self.last_name} ({self.relationship}) for {self.student}"
    
    @property
    def full_name(self):
        return f"{self.first_name} {self.last_name}"


class Classroom(models.Model):
    """Classroom model for physical locations."""
    name = models.CharField(max_length=100)
    building = models.CharField(max_length=100)
    room_number = models.CharField(max_length=20)
    capacity = models.PositiveIntegerField()
    equipment = models.TextField(blank=True, help_text="List of equipment in the classroom")
    is_active = models.BooleanField(default=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        verbose_name = 'Classroom'
        verbose_name_plural = 'Classrooms'
        ordering = ['building', 'room_number']
    
    def __str__(self):
        return f"{self.building} {self.room_number} ({self.name})"


class Resource(models.Model):
    """Educational resource model (documents, videos, etc.)."""
    RESOURCE_TYPES = [
        ('document', 'Document'),
        ('video', 'Video'),
        ('audio', 'Audio'),
        ('link', 'External Link'),
        ('presentation', 'Presentation'),
        ('assignment', 'Assignment Template'),
    ]
    
    course_section = models.ForeignKey(CourseSection, on_delete=models.CASCADE, related_name='resources')
    title = models.CharField(max_length=200)
    description = models.TextField(blank=True)
    resource_type = models.CharField(max_length=20, choices=RESOURCE_TYPES)
    file = models.FileField(upload_to='education/resources/', blank=True, null=True)
    url = models.URLField(blank=True)
    is_public = models.BooleanField(default=True, help_text="Visible to all students in the course")
    created_by = models.ForeignKey(Instructor, on_delete=models.SET_NULL, null=True, blank=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        verbose_name = 'Resource'
        verbose_name_plural = 'Resources'
        ordering = ['-created_at']
    
    def __str__(self):
        return f"{self.title} ({self.resource_type})"
    
    def get_absolute_url(self):
        if self.file:
            return self.file.url
        elif self.url:
            return self.url
        return '#'


class Certificate(models.Model):
    """Student certificate model for course completion."""
    student = models.ForeignKey(Student, on_delete=models.CASCADE, related_name='certificates')
    course = models.ForeignKey(Course, on_delete=models.CASCADE, related_name='certificates')
    certificate_number = models.CharField(max_length=50, unique=True)
    issue_date = models.DateField(default=timezone.now)
    completion_date = models.DateField()
    grade = models.CharField(max_length=2)
    instructor = models.ForeignKey(Instructor, on_delete=models.SET_NULL, null=True, blank=True)
    is_revoked = models.BooleanField(default=False)
    revoked_reason = models.TextField(blank=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        verbose_name = 'Certificate'
        verbose_name_plural = 'Certificates'
        ordering = ['-issue_date']
    
    def __str__(self):
        return f"Certificate {self.certificate_number} for {self.student}"
    
    def get_absolute_url(self):
        return reverse('{{ app_name }}:certificate_detail', kwargs={'pk': self.pk})


class Feedback(models.Model):
    """Feedback model for course evaluations."""
    student = models.ForeignKey(Student, on_delete=models.CASCADE, related_name='feedbacks')
    course_section = models.ForeignKey(CourseSection, on_delete=models.CASCADE, related_name='feedbacks')
    rating = models.PositiveIntegerField(choices=[(i, str(i)) for i in range(1, 6)])  # 1-5 stars
    comment = models.TextField(blank=True)
    is_anonymous = models.BooleanField(default=False)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        verbose_name = 'Feedback'
        verbose_name_plural = 'Feedbacks'
        unique_together = ['student', 'course_section']
        ordering = ['-created_at']
    
    def __str__(self):
        return f"Feedback for {self.course_section} by {self.student}"
    
    @property
    def stars_display(self):
        """Return star rating as string of filled/unfilled stars."""
        filled = '★' * self.rating
        unfilled = '☆' * (5 - self.rating)
        return f"{filled}{unfilled}"