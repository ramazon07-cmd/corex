"""
Fintech-specific models for {{ app_name }} app.

Generated by CoreX - Django Scaffolding Framework
"""

from django.db import models
from django.contrib.auth.models import User
from django.urls import reverse
from django.utils import timezone
from django.utils.text import slugify
from decimal import Decimal


class Account(models.Model):
    """Financial account model."""
    ACCOUNT_TYPES = [
        ('checking', 'Checking'),
        ('savings', 'Savings'),
        ('credit', 'Credit Card'),
        ('investment', 'Investment'),
        ('loan', 'Loan'),
        ('business', 'Business'),
    ]
    
    user = models.ForeignKey(User, on_delete=models.CASCADE, related_name='{{ app_name }}_accounts')
    account_number = models.CharField(max_length=20, unique=True)
    account_type = models.CharField(max_length=20, choices=ACCOUNT_TYPES)
    name = models.CharField(max_length=100)
    balance = models.DecimalField(max_digits=15, decimal_places=2, default=0)
    currency = models.CharField(max_length=3, default='USD')
    is_active = models.BooleanField(default=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        verbose_name = 'Account'
        verbose_name_plural = 'Accounts'
        ordering = ['user', 'account_type']
    
    def __str__(self):
        return f"{self.user.username} - {self.name} ({self.account_type})"
    
    def get_absolute_url(self):
        return reverse('{{ app_name }}:account_detail', kwargs={'pk': self.pk})
    
    @property
    def display_balance(self):
        return f"{self.currency} {self.balance}"


class Transaction(models.Model):
    """Financial transaction model."""
    TRANSACTION_TYPES = [
        ('income', 'Income'),
        ('expense', 'Expense'),
        ('transfer', 'Transfer'),
        ('investment', 'Investment'),
        ('loan_payment', 'Loan Payment'),
    ]
    
    account = models.ForeignKey(Account, on_delete=models.CASCADE, related_name='transactions')
    transaction_type = models.CharField(max_length=20, choices=TRANSACTION_TYPES)
    amount = models.DecimalField(max_digits=15, decimal_places=2)
    currency = models.CharField(max_length=3, default='USD')
    description = models.CharField(max_length=200)
    category = models.CharField(max_length=50, blank=True)
    date = models.DateTimeField(default=timezone.now)
    is_recurring = models.BooleanField(default=False)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        verbose_name = 'Transaction'
        verbose_name_plural = 'Transactions'
        ordering = ['-date']
    
    def __str__(self):
        return f"{self.transaction_type} - {self.amount} ({self.date.date()})"
    
    def get_absolute_url(self):
        return reverse('{{ app_name }}:transaction_detail', kwargs={'pk': self.pk})


class Category(models.Model):
    """Transaction category model."""
    CATEGORY_TYPES = [
        ('income', 'Income'),
        ('expense', 'Expense'),
        ('transfer', 'Transfer'),
    ]
    
    name = models.CharField(max_length=50)
    category_type = models.CharField(max_length=10, choices=CATEGORY_TYPES)
    color = models.CharField(max_length=7, default='#000000')  # Hex color
    icon = models.CharField(max_length=50, blank=True)  # Icon class
    is_active = models.BooleanField(default=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        verbose_name = 'Category'
        verbose_name_plural = 'Categories'
        ordering = ['name']
        unique_together = ['name', 'category_type']
    
    def __str__(self):
        return f"{self.name} ({self.category_type})"


class Budget(models.Model):
    """Budget model for expense tracking."""
    user = models.ForeignKey(User, on_delete=models.CASCADE, related_name='{{ app_name }}_budgets')
    name = models.CharField(max_length=100)
    category = models.ForeignKey(Category, on_delete=models.CASCADE, related_name='budgets')
    amount = models.DecimalField(max_digits=15, decimal_places=2)
    period = models.CharField(max_length=20, choices=[
        ('weekly', 'Weekly'),
        ('monthly', 'Monthly'),
        ('quarterly', 'Quarterly'),
        ('yearly', 'Yearly'),
    ])
    start_date = models.DateField()
    end_date = models.DateField()
    is_active = models.BooleanField(default=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        verbose_name = 'Budget'
        verbose_name_plural = 'Budgets'
        ordering = ['user', '-start_date']
    
    def __str__(self):
        return f"{self.user.username} - {self.name} ({self.period})"
    
    @property
    def spent_amount(self):
        """Calculate amount spent in this budget period."""
        from django.db.models import Sum
        transactions = Transaction.objects.filter(
            account__user=self.user,
            category=self.category,
            date__gte=self.start_date,
            date__lte=self.end_date
        ).aggregate(Sum('amount'))['amount__sum'] or 0
        return transactions
    
    @property
    def remaining_amount(self):
        """Calculate remaining budget amount."""
        return self.amount - self.spent_amount
    
    @property
    def percentage_used(self):
        """Calculate percentage of budget used."""
        if self.amount > 0:
            return (self.spent_amount / self.amount) * 100
        return 0


class Invoice(models.Model):
    """Invoice model for billing."""
    INVOICE_STATUS = [
        ('draft', 'Draft'),
        ('sent', 'Sent'),
        ('paid', 'Paid'),
        ('overdue', 'Overdue'),
        ('cancelled', 'Cancelled'),
    ]
    
    user = models.ForeignKey(User, on_delete=models.CASCADE, related_name='{{ app_name }}_invoices')
    invoice_number = models.CharField(max_length=50, unique=True)
    client_name = models.CharField(max_length=100)
    client_email = models.EmailField(blank=True)
    client_address = models.TextField(blank=True)
    issue_date = models.DateField(default=timezone.now)
    due_date = models.DateField()
    status = models.CharField(max_length=20, choices=INVOICE_STATUS, default='draft')
    subtotal = models.DecimalField(max_digits=15, decimal_places=2, default=0)
    tax_rate = models.DecimalField(max_digits=5, decimal_places=2, default=0)  # Percentage
    tax_amount = models.DecimalField(max_digits=15, decimal_places=2, default=0)
    total_amount = models.DecimalField(max_digits=15, decimal_places=2, default=0)
    currency = models.CharField(max_length=3, default='USD')
    notes = models.TextField(blank=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        verbose_name = 'Invoice'
        verbose_name_plural = 'Invoices'
        ordering = ['-issue_date']
    
    def __str__(self):
        return f"Invoice {self.invoice_number} - {self.client_name}"
    
    def get_absolute_url(self):
        return reverse('{{ app_name }}:invoice_detail', kwargs={'pk': self.pk})
    
    def save(self, *args, **kwargs):
        # Calculate tax and total amounts
        self.tax_amount = self.subtotal * (self.tax_rate / 100)
        self.total_amount = self.subtotal + self.tax_amount
        super().save(*args, **kwargs)


class InvoiceItem(models.Model):
    """Invoice item model."""
    invoice = models.ForeignKey(Invoice, on_delete=models.CASCADE, related_name='items')
    description = models.CharField(max_length=200)
    quantity = models.DecimalField(max_digits=10, decimal_places=2, default=1)
    unit_price = models.DecimalField(max_digits=15, decimal_places=2)
    total_price = models.DecimalField(max_digits=15, decimal_places=2)
    
    class Meta:
        verbose_name = 'Invoice Item'
        verbose_name_plural = 'Invoice Items'
    
    def __str__(self):
        return f"{self.description} - {self.quantity} x {self.unit_price}"
    
    def save(self, *args, **kwargs):
        self.total_price = self.quantity * self.unit_price
        super().save(*args, **kwargs)


class PaymentMethod(models.Model):
    """Payment method model."""
    PAYMENT_TYPES = [
        ('credit_card', 'Credit Card'),
        ('debit_card', 'Debit Card'),
        ('bank_transfer', 'Bank Transfer'),
        ('paypal', 'PayPal'),
        ('cryptocurrency', 'Cryptocurrency'),
        ('cash', 'Cash'),
    ]
    
    user = models.ForeignKey(User, on_delete=models.CASCADE, related_name='{{ app_name }}_payment_methods')
    name = models.CharField(max_length=100)
    payment_type = models.CharField(max_length=20, choices=PAYMENT_TYPES)
    is_default = models.BooleanField(default=False)
    is_active = models.BooleanField(default=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        verbose_name = 'Payment Method'
        verbose_name_plural = 'Payment Methods'
        ordering = ['user', '-is_default', 'name']
    
    def __str__(self):
        return f"{self.user.username} - {self.name} ({self.payment_type})"


class RecurringTransaction(models.Model):
    """Recurring transaction model."""
    FREQUENCY_CHOICES = [
        ('daily', 'Daily'),
        ('weekly', 'Weekly'),
        ('biweekly', 'Bi-weekly'),
        ('monthly', 'Monthly'),
        ('bimonthly', 'Bi-monthly'),
        ('quarterly', 'Quarterly'),
        ('yearly', 'Yearly'),
    ]
    
    user = models.ForeignKey(User, on_delete=models.CASCADE, related_name='{{ app_name }}_recurring_transactions')
    name = models.CharField(max_length=100)
    amount = models.DecimalField(max_digits=15, decimal_places=2)
    currency = models.CharField(max_length=3, default='USD')
    description = models.CharField(max_length=200)
    category = models.ForeignKey(Category, on_delete=models.CASCADE, related_name='recurring_transactions')
    frequency = models.CharField(max_length=20, choices=FREQUENCY_CHOICES)
    start_date = models.DateField()
    end_date = models.DateField(null=True, blank=True)
    next_occurrence = models.DateField()
    is_active = models.BooleanField(default=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        verbose_name = 'Recurring Transaction'
        verbose_name_plural = 'Recurring Transactions'
        ordering = ['user', '-next_occurrence']
    
    def __str__(self):
        return f"{self.name} - {self.amount} ({self.frequency})"


class Investment(models.Model):
    """Investment tracking model."""
    INVESTMENT_TYPES = [
        ('stock', 'Stock'),
        ('bond', 'Bond'),
        ('mutual_fund', 'Mutual Fund'),
        ('etf', 'ETF'),
        ('cryptocurrency', 'Cryptocurrency'),
        ('real_estate', 'Real Estate'),
        ('commodity', 'Commodity'),
    ]
    
    user = models.ForeignKey(User, on_delete=models.CASCADE, related_name='{{ app_name }}_investments')
    name = models.CharField(max_length=100)
    investment_type = models.CharField(max_length=20, choices=INVESTMENT_TYPES)
    symbol = models.CharField(max_length=20, blank=True)
    quantity = models.DecimalField(max_digits=15, decimal_places=4)
    purchase_price = models.DecimalField(max_digits=15, decimal_places=4)
    current_price = models.DecimalField(max_digits=15, decimal_places=4, null=True, blank=True)
    purchase_date = models.DateField()
    broker = models.CharField(max_length=100, blank=True)
    is_active = models.BooleanField(default=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        verbose_name = 'Investment'
        verbose_name_plural = 'Investments'
        ordering = ['user', 'name']
    
    def __str__(self):
        return f"{self.name} - {self.quantity} shares"
    
    @property
    def current_value(self):
        """Calculate current value of investment."""
        if self.current_price:
            return self.quantity * self.current_price
        return None
    
    @property
    def gain_loss(self):
        """Calculate gain/loss on investment."""
        if self.current_price:
            purchase_value = self.quantity * self.purchase_price
            current_value = self.quantity * self.current_price
            return current_value - purchase_value
        return None
    
    @property
    def gain_loss_percentage(self):
        """Calculate gain/loss percentage."""
        if self.current_price and self.purchase_price > 0:
            return ((self.current_price - self.purchase_price) / self.purchase_price) * 100
        return None


class FinancialGoal(models.Model):
    """Financial goal tracking model."""
    user = models.ForeignKey(User, on_delete=models.CASCADE, related_name='{{ app_name }}_financial_goals')
    name = models.CharField(max_length=100)
    target_amount = models.DecimalField(max_digits=15, decimal_places=2)
    current_amount = models.DecimalField(max_digits=15, decimal_places=2, default=0)
    target_date = models.DateField()
    description = models.TextField(blank=True)
    is_achieved = models.BooleanField(default=False)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        verbose_name = 'Financial Goal'
        verbose_name_plural = 'Financial Goals'
        ordering = ['user', '-target_date']
    
    def __str__(self):
        return f"{self.name} - {self.current_amount}/{self.target_amount}"
    
    @property
    def progress_percentage(self):
        """Calculate progress percentage toward goal."""
        if self.target_amount > 0:
            return (self.current_amount / self.target_amount) * 100
        return 0
    
    @property
    def days_remaining(self):
        """Calculate days remaining to reach goal."""
        if self.target_date:
            delta = self.target_date - timezone.now().date()
            return delta.days
        return None